{% extends "lessons/base.html" %}
{% load static %}

{% block title %}Teacher Dashboard{% endblock %}

{% block content %}

<!-- Profile Section with school badge background like website home page -->
<div style="
    background-image: linear-gradient(to right, rgba(0, 0, 0, 0.4), rgba(245, 248, 252, 0.95)),
                      url('/media/LOGO/school%20badge.jpg');
    background-size: cover;
    background-position: left center;
    border-radius: 0.75rem;
    padding: 1.5rem 1rem;
    margin-bottom: 16px;
  ">
  <div class="profile-container" style="display:flex; align-items:center; gap:16px; color:#ffffff;">
    <form action="{% url 'update_profile_picture' %}" method="post" enctype="multipart/form-data" style="margin:0;">
        {% csrf_token %}
        <label for="profile_picture" style="cursor:pointer; display:inline-block;">
            {% if teacher.profile_picture %}
                <img src="{{ teacher.profile_picture.url }}" alt="Profile Picture">
            {% else %}
                <img src="{% static 'lessons/img/default_profile.png' %}" alt="Default Profile Picture">
            {% endif %}
        </label>
        <input type="file" name="profile_picture" id="profile_picture" style="display:none;" onchange="this.form.submit();">
    </form>

    {% if teacher.profile_picture %}
    <form action="{% url 'update_profile_picture' %}" method="post" style="margin:0;">
        {% csrf_token %}
        <button type="submit" name="delete_picture" value="1" class="logout-btn">Delete</button>
    </form>
    {% endif %}

    <div style="flex:1; text-align:center;">
      <div style="font-size:1.4rem; font-weight:700; color:#ffffff;">Lukore Secondary School</div>
      <div style="font-size:0.95rem; margin-top:4px; color:#e5e7eb;">Welcome, {{ teacher.user.get_full_name }}</div>
    </div>
  </div>
</div>

<!-- Filters -->
<div class="filters">
    <form method="get">
        <label>Week:</label>
        <select name="week">
            <option value="">All</option>
            {% for week in weeks %}
                <option value="{{ week.id }}" {% if week.id|stringformat:"s" == selected_week %}selected{% endif %}>
                    Week {{ week.number }}
                </option>
            {% endfor %}
        </select>

        <label>Class:</label>
        <select name="class_group">
            <option value="">All</option>
            {% for c in classes %}
                <option value="{{ c.id }}" {% if c.id|stringformat:"s" == selected_class %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
        </select>

        <label>Subject:</label>
        <select name="subject">
            <option value="">All</option>
            {% for s in subjects %}
                <option value="{{ s.id }}" {% if s.id|stringformat:"s" == selected_subject %}selected{% endif %}>{{ s.name }}</option>
            {% endfor %}
        </select>

        <button type="submit">Filter</button>
    </form>
</div>

<!-- Summary Cards -->
<div class="cards-container">
    <div class="card"><h3>Total Lessons</h3><p>{{ total_lessons }}</p></div>
    <div class="card"><h3>Attended</h3><p>{{ attended }}</p></div>
    <div class="card"><h3>Not Attended</h3><p>{{ not_attended }}</p></div>
    <div class="card"><h3>Pending</h3><p>{{ pending }}</p></div>
   
    <div class="card"><h3>Paid Lessons</h3><p>{{ paid }}</p></div>
    <div class="card"><h3>Unpaid Lessons</h3><p>{{ unpaid }}</p></div>
    <div class="card"><h3>Total Paid Amount</h3><p>${{ total_paid_amount|floatformat:2 }}</p></div>
    <div class="card"><h3>Total Unpaid Amount</h3><p>${{ total_unpaid_amount|floatformat:2 }}</p></div>
</div>

<!-- Quick Actions -->
<div class="cards-container">
    <div class="card">
        <h3>Add Lesson</h3>
        <p>Create a new lesson record.</p>
        <a href="{% url 'add_lesson' %}" class="btn">âž• Add Lesson</a>
    </div>
   
</div>

<!-- Lessons Table -->
<h2>Lessons Details</h2>
<table>
    <thead>
        <tr>
            <th>Week</th>
            <th>Class</th>
            <th>Subject</th>
            <th>Status</th>
            <th>Payment Status</th>
            <th>Amount</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for lesson in lessons %}
        <tr>
            <td>{{ lesson.week.number }}</td>
            <td>
                {% for c in lesson.timetable.class_groups.all %}
                    {{ c.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </td>
            <td>{{ lesson.timetable.subject }}</td>
            <td>{{ lesson.status }}</td>
            <td>{{ lesson.payment_status }}</td>
            <td>${{ lesson.amount|floatformat:2 }}</td>
            <td>
                {% if lesson.status == "not_attended" or lesson.status == "pending" %}
                    <form action="{% url 'mark_attended' lesson.id %}" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit">âœ… Mark Attended</button>
                    </form>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="7">No lessons found.</td></tr>
        {% endfor %}
    </tbody>

{% if teacher.is_class_teacher %}
<div class="card">
    <h2>ðŸ’° Student Payments</h2>
    <p>Record student payments for your class.</p>
    <a href="{% url 'student_payments' %}" class="btn btn-success mt-3">Go to Payments</a>
</div>
{% endif %}

{% endblock %}
<form method="post">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit">Save</button>
</form>
